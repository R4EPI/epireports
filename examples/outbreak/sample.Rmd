---
title: "Outbreak report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(dplyr)

# epi packages
library(epireports)
library(incidence)
library(ISOweek) 
library(epitools)
```

This is a test document to gather functions and code snippets that eventually will evolve into an outbreak report template (+ package(s)).

```{r}
# read data from CSV
#linelist_raw <- readr::read_csv("linelist.csv")

# read data from Excel
# linelist_raw <- readxl::read_xlsx

linelist_raw <- outbreaks::fluH7N9_china_2013

### Data preparation

# Here document everything you do to clean the data.


# a good first step is to assign standard column names so that subsequent code
# uses stable column names. 
# in case the input data changes, you just need to fix the column mapping
# TODO: showcase and recommend the linelist package

# make a copy of your original dataset 
linelist_cleaned <- linelist_raw
# define clean variable names
cleaned_colnames <- epitrix::clean_labels(colnames(linelist_raw))
# overwrite variable names with defined clean names
colnames(linelist_cleaned) <- cleaned_colnames

# alternatively you can manually rename columns
linelist_cleaned <- rename(linelist_cleaned, sex = gender)
```


```{r}
# THIS CAN BE DELETED WHEN WE USE A DIFFERENT DATASET 
# its just to be able to demonstrate posibilities

# generate artificial lab tests, symptoms and contact vars
lab_results <- linelist_cleaned %>% 
                select(case_id) %>% 
                mutate(test_result = sample(c("Positive", "Negative"),
                                            nrow(linelist_cleaned), 
                                            replace = T), 
                       symptoms = sample(c("Yes", "No"),
                                            nrow(linelist_cleaned), 
                                            replace = T),
                       contact = sample(c("Yes", "No"),
                                            nrow(linelist_cleaned), 
                                            replace = T)
                )

# generate some artificial population data
population <- distinct(linelist_cleaned, province)
population$population <- as.integer(runif(nrow(population), 
                                          min = 10^3, max = 10^5))


```




```{r}
# merging linelist with lab dataset 
linelist_cleaned <- left_join(linelist_cleaned, lab_results, 
                              by = "case_id")
```



```{r}
# Next, document anything to clean data. Use dplyr for that.

# create an age group variable by specifying categorical breaks
linelist_cleaned$age_group <- age_categories(linelist_cleaned$age, 
                                             breakers = c(0, 5, 10, 30, 50, 80))

# alternatively, create an age group variable specify a sequence
# linelist_cleaned$age_group <- age_categories(linelist_cleaned$age,
#                                              lower = 0, 
#                                              upper = 100, 
#                                              by = 10)


# Change the levels of a categorical variable
linelist_cleaned$sex <- recode_factor(linelist_cleaned$sex, 
                                      f = "Female", 
                                      m = "Male")

# create a case definition variable 
linelist_cleaned$case_def <- ifelse(linelist_cleaned$test_result == "Positive", 
                                    "Confirmed", "Possible")
linelist_cleaned$case_def[linelist_cleaned$case_def != "Confirmed" & 
                            linelist_cleaned$symptoms == "Yes"] <- "Probable"


# create an epiweek variable 
linelist_cleaned$epiweek <- ISOweek(linelist_cleaned$date_of_onset)


# ... TODO: add some snippets for cleaing data
```


```{r}
# You might want to remove columns and other personal data

# remove the name columns
linelist_cleaned$name <- NULL
```





### Person

* [Who is affected: how many in total; male or female; young, adult or old? What are the links between affected people â€“ work place, school, social gathering?  Is there a high rate of illness in contacts?  Is there a high rate of illness in health workers? You may want to include:  a bar chart showing case numbers or incidence by age group and sex; attack rates (AR); and numbers of deaths (in suspected and confirmed cases), mortality rates and/or case fatality ratio (CFR)]  
DO THE DESCRIPTIVES BASED ON CASE CLASSIFICATION STRATIFICATION ALSO

#### Age

Cases by sex

```{r}
linelist_cleaned %>%
  group_by(sex) %>%
  summarise(cases = n()) %>%
  kable()
```

Cases by age group

```{r}
linelist_cleaned %>%
  group_by(age_group) %>%
  summarise(cases = n()) %>%
  kable()
```

Age pyramid


```{r}
plot_age_pyramid(filter(linelist_cleaned, !is.na(sex)))
```


CFR 

```{r}
known_status <- linelist_cleaned[!is.na(linelist_cleaned$outcome), ]
deaths <- sum(known_status$outcome == "Death")
population <- length(linelist_cleaned$outcome)
```


```{r}
case_fatality_rate(deaths, population) %>% knitr::kable()
```


CFR by age group

```{r}
group_by(known_status, age_group) %>%
  do({
    deaths <- sum(.$outcome == "Death")
    population <- length(.$outcome)
    case_fatality_rate(deaths, population)
  }) %>%
  arrange(desc(lower)) %>%
  knitr::kable()
```

#### Attack rate

```{r}
attack_rate(nrow(linelist_cleaned), 10 * population)
```
 ADD ATTACK RATE BY WEEK!!!!!
 
 Cummulative attack week as weeks go on 
 and one that is sepereate counts for each week

#### Mortality


Mortality rate per 100,000:

```{r}
mortality_rate(deaths, population, multiplier = 10^4) %>%
  kable()
```


#### 2x2 tables

```{r}
sex_table <- epitools::epitable(linelist_cleaned$sex, linelist_cleaned$outcome)
sex_table
```

```{r}
sex_rr <- epitools::riskratio(sex_table, correct = TRUE, method = "wald")
sex_rr
```


```{r}
epitools::oddsratio(sex_table, correction = TRUE, method = "wald")
```


### Time

* [When did the cases fall ill? Are numbers increasing or stable? You may want to include an Epi curve (bar chart showing number of new (suspected and confirmed) cases each day/week) ]


```{r}
inc_week_7 <- incidence(linelist_cleaned$date_of_onset, interval = 7)
```

```{r}
plot(inc_week_7, show_cases = TRUE, border = "black") + 
  labs(x = "Calendar week", y = "Cases (n)")
```

```{r}
inc_week_7 <- incidence(linelist_cleaned$date_of_onset, 
                        interval = 7, 
                        groups = linelist_cleaned$sex)
plot(inc_week_7, show_cases = TRUE, border = "black") + 
  labs(x = "Calendar week", y = "Cases (n)")
```


### Place

*  [Across what area: one or several villages, all from same school, etc. You may want to include a map of the distribution of cases; attack rates by location]


#### Quick and simple map with ggmap

Just WIP. Not sure if ggmap is a good approach.

DO THIS WITH ALL OF CHINA FOR A CHOROPLETH USING GADM SHAPEFILES 
ALSO GET OSM TILES AND DATA 


```{r, message=FALSE}
bb <- osmdata::getbb("Western Area Urban, Sierra Leone")

# generate artificial coords

ll_geo <- linelist_cleaned %>% 
  mutate(Longitude = runif(nrow(linelist_cleaned), bb[1, 1], bb[1, 2]),
         Latitude = runif(nrow(linelist_cleaned), bb[2, 1], bb[2, 2]))

library(ggmap)
b <- get_map(as.numeric(bb), maptype = "toner-lite", source = "stamen")
ggmap(b) + 
  geom_point(data = ll_geo, aes(x = Longitude, y = Latitude, color = outcome))
```


#### Mortality rate per district

```{r}

linelist_cleaned %>%
  filter(!is.na(outcome)) %>%
  group_by(province) %>%
  do({
    province <- as.character(.$province[1])
    deaths <- sum(.$outcome == "Death")
    pop <- population[population$province == province, "population"]
    mortality_rate(deaths, pop, multiplier = 10^3)
  }) %>%
  mutate_if(is.numeric, funs(round(., digits = 2))) %>%
  kable(col.names = c("Province", "Number of cases", "Population",
                      "Incidence per 1000", "Lower 95% CI", "Upper 95% CI"))
```

