---
title: "Vaccination survey"
output: github_document
---


# Introduction to this template
This is a template which will guide you through the following steps:  
  - merging household and individual level data
  - calculating overall proportion of children <15 vaccinated against a specific pathogen
  - calculating proportion of children <15 vaccinated against a specific pathogen by age group, location and gender
  

```{r setup, include=FALSE}
# hide all code chunks in the output, but show errors
knitr::opts_chunk$set(echo = FALSE, error = TRUE, fig.width = 16, fig.height = 12)
# set default NA to - in output, define figure width/height
options(knitr.kable.NA = "-")


library(knitr) # for creating output doc
library(dplyr) # for cleaning/shaping data
library(ggplot2) # for plotting diagrams
library(rio) # for importing data
library(tidyr) # for cleaning data
library(epitrix) # for cleaning data

# epi packages
library(devtools) # for installing sitrep package
library(incidence) # for epicurves
library(ISOweek) # for creating epiweeks
library(epitools) # for creating 2by2 tables
library(survey)


devtools::install_github("R4EPI/sitrep")

#set default text size to 16 for plots
ggplot2::theme_set(theme_bw(base_size = 18))
```


```{r data import}
# read in data
# you can use rio to read in tabular data (Excel/csv) files
## Read data ------------------------------------
# CSV file
# vaccination_raw <- rio::import("vaccination.csv")
#
# Excel file
# to read in a specific sheet use "which"
# vaccination_raw <- rio::import("vaccination.xlsx", which = "Sheet1")
#
# Stata data file
# vaccination_raw <- rio::import("vaccination.dat")
#
# For password protected Excel file 
# use the excel.link package 
# library(excel.link)
# vaccineation_raw <- excel.link::xl.read.file("vaccination.xlsx",
#                                          xl.sheet = "Sheet1",
#                                          password = askpass::askpass(prompt = "please enter file
#                                                                      password"))



vaccination_raw <- sitrep::gen_data(dictionary = "Vaccination", varnames = "column_name",
                         numcases = 1000)


# Add in information on household number, age and cluster number
vaccination_raw$q14_hh_no <- sample(1:300, 1000, replace = TRUE)

vaccination_raw$q77_what_is_the_cluster_number <- sample(1:30, 1000, replace = TRUE)

vaccination_raw$q10_age_yr <- sample(0:14, 1000, replace = TRUE)

vaccination_raw$q55_age_mth <- sample(0:11, 1000, replace = TRUE)

vaccination_raw$q17_vaccine_mass <- sample(c("No", "Yes - Verbal", "Yes - Vaccination card",
                                            "Don't know", "No answer"), 1000, replace = TRUE)


```

```{r read_population_data, warning = FALSE, message = FALSE}

# create fake population by age and sex 
population_data_age <- tibble(age_group = rep.int(c("0-0", "1-1", "2-2", "3-3", "4-4", "5+"), 2), 
                              sex = rep.int(c("Male", "Female"), 6))
population_data_age$population <- as.integer(runif(nrow(population_data_age), 
                                          min = 500, max = 2000))

```



```{r data cleaning}

# clean up the column names
colnames(vaccination_raw) <- clean_labels(colnames(vaccination_raw))


# Additional variable name cleaning and creation of vaccination status binary variable
vaccination_clean <- vaccination_raw %>%
                      mutate(age_in_years = as.integer(q10_age_yr),
                             age_in_months = as.integer(q55_age_mth),
                             age_group = sitrep::age_categories(age_in_years, breakers = c(0,1,2,3,4,5)),
                             sex = q5_sex,
                             vaccination_routine = q2_vaccine_9months,
                             vaccination_sia = q32_vaccine_sia,
                             vaccine_mass = q17_vaccine_mass,
                             disease_diagnosis = q47_disease_diagnosis,
                             area = q4_settlement,
                             cluster = q77_what_is_the_cluster_number)
                             

```


```{r survey weights}
######## WEIGHTING 

vaccination_clean <- add_weights(vaccination_clean, population_data_age, age_group, sex)
```




```{r survey design}

# we first need to create a survey design that reflects the study
survey_design <- svydesign(
  ids = ~ cluster, # cluster id is stored as cluster
  weights = weights, #sampling weights applied to this example
  data = vaccination_raw_clean
)
```



## Characteristics of the sampled children

Children included in the survey by sex
```{r participant description by sex}

# get counts and proportions of participants by sex
descriptive(vaccination_raw_clean, "sex") %>%
  # change table column names 
  # rename( new variable name = old variable name)
  rename("Sex" = sex, "Number of participants (n)" = n,"Proportion (%)" =  prop) %>% 
  kable(digits = 2)
```


Children included in the survey by age group
```{r participant description by age group}

# get counts and proportions of participants by age group
descriptive(vaccination_raw_clean, "age_group") %>%
  # change table column names 
  # rename( new variable name = old variable name)
  rename("Age group" = age_group, "Number of participants (n)" = n,"Proportion (%)" =  prop) %>% 
  kable(digits = 2)
```

Age pyramid

```{r age_pyramid, warning=FALSE}
# plot age pyramid 
plot_age_pyramid(vaccination_raw_clean, age_group = "age_group", split_by = "sex") + 
  labs(x = "Number of included children", y = "Age group (months)") +                    # change axis labels
  theme(legend.position = "bottom", legend.title = element_blank())   # remove title and move legend
```


# Vaccination coverage
Accepting equal validity from self-reported and card-reported vaccination status
```{r vaccination coverage overall}

survey_ciprob(survey_design, "vaccination_status_simple") %>%
  kable()
```


```{r vaccination coverage by sex}

survey_ciprob(survey_design, "vaccine_status_simple", "sex") %>%
  kable()
```


```{r vaccination coverage by age group}

survey_ciprob(survey_design, "vaccine_status_simple", "age_group") %>%
  kable()
```

TO DO
- Add similar breakdown but comparing self reporting vs card reporting
