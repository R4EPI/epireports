---
title: "Vaccination survey"
output: word_document
---



# Introduction to this template

This is a template which can be used to create a report from a vaccination 
coverage survey. 

- There are sections for reading and cleaning data, followed by 
    weighting and observation time calculations and then survey analysis. 
    Use the drop-down menu on the bottom left of this script window to jump 
    between sections. 
- You can type normal text in white spaces (such as here) and r-code in grey
    spaces (denoted by three backticks and r) (see [Rmarkdown
    introduction](https://rmarkdown.rstudio.com/articles_intro.html) and
    [Markdown basics](https://rmarkdown.rstudio.com/authoring_basics.html))
- Introductions and contents of sections are within square brackets "[...]" and
    can be deleted as appropriate
- Examples of inline code (to automate updating numbers, e.g. in the "Results
    section"), can similarly be removed/updated
- Code itself can be deleted, but as a word of caution: make sure you aren't
    deleting bits where variables are created/manipulated, or at least update
    them appropriatley
- For a more detailed exaplanation of this template, see [Wiki](https://github.com/R4EPI/sitrep/wiki)

This template will guide you through the following steps:  
  - merging household and individual level data
  - calculating overall proportion of children <15 vaccinated against a specific pathogen
  - calculating proportion of children <15 vaccinated against a specific pathogen by age group, location and gender


## Installing and loading required packages 

Several packages are required for different aspects of  analysis with *R*. 
You will need to install these before starting. 
We will be using the following packages. Some of these packages automatically
install other packages they need to work (called dependencies).

These packages can be quite large and may take a while to download in the
field. If you have access to a USB key with these packages, it makes sense to
copy and paste the packages into Program Files/R/R-[version]/library.
  

```{r setup, include = FALSE, results='hide', message=FALSE, warning=FALSE}
# hide all code chunks in the output, but show errors
knitr::opts_chunk$set(echo = FALSE, error = TRUE, fig.width = 6*1.25, fig.height = 6)
# set default NA to - in output, define figure width/height
options(knitr.kable.NA = "-")

# Installing required packages for this template
required_packages <- c("knitr",       # create output docs
                       "rio",         # for importing data
                       "epitrix",     # clean/shape data
                       "dplyr",       # clean/shape data
                       "tidyr",       # clean/shape data
                       "forcats",     # clean/shape data
                       "ggplot2",     # create plots and charts
                       "sitrep",      # MSF field epi functions
                       "survey",      # for survey functions
                       "srvyr"        # dplyr wrapper for survey package
                       )

for (pkg in required_packages) {
  # install packages if not already present
  if (!pkg %in% rownames(installed.packages())) {
    install.packages(pkg)
  }
  
  # load packages to this current session 
  library(pkg, character.only = TRUE)
}
# set default text size to 16 for plots
# give classic black/white axes for plots
ggplot2::theme_set(theme_classic(base_size = 18))
```



```{r read_data_generic, message = FALSE}

## This section gives a variety of options for reading in datasets in different formats

## Read data ------------------------------------
# CSV file
# linelist_raw <- rio::import("linelist.csv")
#
# Excel file
# to read in a specific sheet use "which"
# linelist_raw <- rio::import("linelist.xlsx", which = "Sheet1")
#
# Stata data file
# linelist_raw <- rio::import("linelist.dat")
#
# For password protected Excel file 
# use the excel.link package 
# library(excel.link)
# linelist_raw <- excel.link::xl.read.file("linelist.xlsx",
#                                          xl.sheet = "Sheet1",
#                                          password = askpass::askpass(prompt = "please enter file
#                                                                      password"))

```





```{r read_dharma_excel_data, message = FALSE}

# If your linelist is an excel export of data from Dharma use this code chunk
# If that is not the case use the code chunk above reading in other formats

## Read data ------------------------------------------------------

# This assums that you have two levels in your survey (level 0 and level 1). 
# These correspond to, for example, household and individual. 
# We will read in and later merge these two levels in to one dataset. 
# We will assume the data is not password protected (code for reading 
# password protected excels is in the read_data_generic code chunk)

## read in household data sheet
# study_data_hh <- rio::import("mortality_survey.xlsx", 
#                               which = "Level 0 Named", na = ".")

## read in individual level data sheet
# study_data_indiv <- rio::import("mortality_survey.xlsx", 
#                               which = "Level 1 Named", na = ".")

## DELETE THIS LINE --- YOU READ IN YOUR OWN DATA ABOVE!
# generates a fake dataset for use as an example in this template
study_data_raw <- gen_data(dictionary = "Vaccination", 
                         varnames = "column_name",
                         numcases = 1000)

## Data dictionary ---------------
## The data dictionary has variable names in the "column_name" column.
## Possible values for variables are specified in the "choice_code" and "choice_name"
## columns. 
## Where code has the shortened values and name has the full text values.

# read in data dictionary (for reference purposes)
# study_data_dict <- import("vaccination_survey.xlsx",
#                       which = "Data Dictionary")

## you can look at the dictionary by uncommenting the line below
# View(study_data_dict) 

## you can view variable names in the data dicationry uncommenting the line below
# study_data_dict$column_name

## DELETE THIS LINE --- YOU READ IN YOUR OWN DATA ABOVE!
# generates a fake dataset for use as an example in this template
# this dataset already has the two levels merged
# variable names are in the column_name column
# possible values for each variable are specified in the "Code" columns.
study_data_dict <- msf_dict_survey("Vaccination")
```


```{r merge_data_levels}

## Need to merge individual data with household data
## This is done using a unique identifier for the household 
## (which repeats in the individuals dataset) 
## For a Dharma dataset this variable is "fact_0_id"

## fact_0_id, the merging variable, needs to be applied to all relevant rows in the indidivual data set
## (equivalent of dragging down with mouse in excel)
## this is achieved using the fill function from the tidyr package
# study_data_indiv <- study_data_indiv %>%
#                       fill(fact_0_id)

## join the individual and household data to form a complete data set
#study_data_raw <- left_join(study_data_hh, study_data_indiv, by = "fact_0_id")
```


```{r read_population_data, warning = FALSE, message = FALSE}

# create fake population by age and sex 
population_data_age <- tibble(age_group = rep.int(c("0-0", "1-1", "2-2", "3-3", "4-4", "5+"), 2), 
                              sex = rep.int(c("Male", "Female"), 6))
population_data_age$population <- as.integer(runif(nrow(population_data_age), 
                                          min = 500, max = 2000))

```



```{r data cleaning}

# clean up the column names
colnames(vaccination_raw) <- clean_labels(colnames(vaccination_raw))


# Additional variable name cleaning and creation of vaccination status binary variable
vaccination_clean <- vaccination_raw %>%
                      mutate(age_in_years = as.integer(q10_age_yr),
                             age_in_months = as.integer(q55_age_mth),
                             age_group = sitrep::age_categories(age_in_years, breakers = c(0,1,2,3,4,5)),
                             sex = q5_sex,
                             vaccination_routine = q2_vaccine_9months,
                             vaccination_sia = q32_vaccine_sia,
                             vaccine_mass = q17_vaccine_mass,
                             disease_diagnosis = q47_disease_diagnosis,
                             area = q4_settlement,
                             cluster = q77_what_is_the_cluster_number)
                             

```


```{r survey weights}
######## WEIGHTING 

vaccination_clean <- add_weights(vaccination_clean, population_data_age, age_group, sex)
```




```{r survey design}

# we first need to create a survey design that reflects the study
survey_design <- svydesign(
  ids = ~ cluster, # cluster id is stored as cluster
  weights = weights, #sampling weights applied to this example
  data = vaccination_raw_clean
)
```



## Characteristics of the sampled children

Children included in the survey by sex
```{r participant description by sex}

# get counts and proportions of participants by sex
descriptive(vaccination_raw_clean, "sex") %>%
  # change table column names 
  # rename( new variable name = old variable name)
  rename("Sex" = sex, "Number of participants (n)" = n,"Proportion (%)" =  prop) %>% 
  kable(digits = 2)
```


Children included in the survey by age group
```{r participant description by age group}

# get counts and proportions of participants by age group
descriptive(vaccination_raw_clean, "age_group") %>%
  # change table column names 
  # rename( new variable name = old variable name)
  rename("Age group" = age_group, "Number of participants (n)" = n,"Proportion (%)" =  prop) %>% 
  kable(digits = 2)
```

Age pyramid

```{r age_pyramid, warning=FALSE}
# plot age pyramid 
plot_age_pyramid(vaccination_raw_clean, age_group = "age_group", split_by = "sex") + 
  labs(x = "Number of included children", y = "Age group (months)") +                    # change axis labels
  theme(legend.position = "bottom", legend.title = element_blank())   # remove title and move legend
```


# Vaccination coverage
Accepting equal validity from self-reported and card-reported vaccination status
```{r vaccination coverage overall}

survey_ciprob(survey_design, "vaccination_status_simple") %>%
  kable()
```


```{r vaccination coverage by sex}

survey_ciprob(survey_design, "vaccine_status_simple", "sex") %>%
  kable()
```


```{r vaccination coverage by age group}

survey_ciprob(survey_design, "vaccine_status_simple", "age_group") %>%
  kable()
```

TO DO
- Add similar breakdown but comparing self reporting vs card reporting
